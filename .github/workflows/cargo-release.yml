# .github/workflows/cargo-release.yml
# Place this in: Ajustor/.github repo (special repo for account-wide workflows)

name: Cargo Build & Release

on:
  workflow_call:
    inputs:
      targets:
        description: 'JSON array of targets: "windows", "linux", "macos"'
        required: true
        type: string
      package_name:
        description: 'Binary name (defaults to repo name)'
        required: false
        type: string
      publish_to_crate:
        description: 'Force publishing to crate'
        required: false
        type: boolean
    secrets:
      CARGO_REGISTRY_TOKEN:
        description: 'crates.io token (optional, for future use)'
        required: false
    


jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      package_name: ${{ steps.pkg.outputs.name }}
      should_publish: ${{ steps.check-token.outputs.should_publish }}
    steps:
      - uses: actions/checkout@v4

      - name: Determine package name
        id: pkg
        run: |
          if [ -n "${{ inputs.package_name }}" ]; then
            echo "name=${{ inputs.package_name }}" >> "$GITHUB_OUTPUT"
          else
            # Extract from Cargo.toml
            NAME=$(grep -m1 '^name' Cargo.toml | sed 's/name *= *"\(.*\)"/\1/')
            echo "name=$NAME" >> "$GITHUB_OUTPUT"
          fi

      - name: Check if should publish to crates.io
        id: check-token
        run: |
          if [ -n "${{ secrets.CARGO_REGISTRY_TOKEN }}" ]; then
            echo "should_publish=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Build target matrix
        id: set-matrix
        run: |
          TARGETS='${{ inputs.targets }}'
          MATRIX="["
          FIRST=true

          for target in $(echo "$TARGETS" | jq -r '.[]'); do
            case "$target" in
              windows)
                [ "$FIRST" = true ] && FIRST=false || MATRIX+=","
                MATRIX+='{"target":"x86_64-pc-windows-msvc","os":"windows-latest","ext":".exe"}'
                ;;
              linux)
                [ "$FIRST" = true ] && FIRST=false || MATRIX+=","
                MATRIX+='{"target":"x86_64-unknown-linux-gnu","os":"ubuntu-latest","ext":""}'
                ;;
              macos)
                [ "$FIRST" = true ] && FIRST=false || MATRIX+=","
                MATRIX+='{"target":"x86_64-apple-darwin","os":"macos-latest","ext":""}'
                MATRIX+=', '
                MATRIX+='{"target":"aarch64-apple-darwin","os":"macos-latest","ext":""}'
                ;;
            esac
          done

          MATRIX+="]"
          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"

  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Format check
        run: cargo fmt --check

      # - name: Clippy
      #   run: cargo clippy -- -D warnings

  test:
    runs-on: ubuntu-latest
    needs: check
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Run tests
        run: cargo test --all-features

  build:
    needs: [prepare, test]
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      - name: Build release
        run: cargo build --release --target ${{ matrix.target }}

      - name: Rename binary
        shell: bash
        run: |
          PKG="${{ needs.prepare.outputs.package_name }}"
          SRC="target/${{ matrix.target }}/release/${PKG}${{ matrix.ext }}"
          DST="${PKG}-${{ matrix.target }}${{ matrix.ext }}"
          cp "$SRC" "$DST"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ needs.prepare.outputs.package_name }}-${{ matrix.target }}
          path: ${{ needs.prepare.outputs.package_name }}-${{ matrix.target }}${{ matrix.ext }}

  publish:
    needs: [prepare, test]
    if: inputs.publish_to_crate || needs.prepare.outputs.should_publish == true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Publish to crates.io
        run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}


  release:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: artifacts/*
