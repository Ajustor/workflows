# .github/workflows/cargo-release.yml
# Place this in: Ajustor/.github repo (special repo for account-wide workflows)

name: Cargo Build & Release

on:
  workflow_call:
    inputs:
      targets:
        description: 'JSON array of targets: "windows", "linux", "macos"'
        required: true
        type: string
      package_name:
        description: 'Binary name (defaults to repo name)'
        required: false
        type: string
      publish_to_crate:
        description: 'Force publishing to crate'
        required: false
        type: boolean
      version:
        description: 'Version to release (used as tag name, e.g. "1.2.3"). If omitted, extracted from Cargo.toml.'
        required: false
        type: string
      deploy_pages:
        description: 'Deploy documentation to GitHub Pages (defaults to false)'
        required: false
        type: boolean
        default: false
    secrets:
      CARGO_REGISTRY_TOKEN:
        description: 'crates.io token (optional, for future use)'
        required: false

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      package_name: ${{ steps.pkg.outputs.name }}
      version: ${{ steps.ver.outputs.version }}
      should_publish: ${{ steps.check-token.outputs.should_publish }}
    steps:
      - uses: actions/checkout@v4

      - name: Determine version
        id: ver
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            echo "version=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            VER=$(grep -m1 '^version' Cargo.toml | sed 's/version *= *"\(.*\)"/\1/')
            echo "version=$VER" >> "$GITHUB_OUTPUT"
          fi

      - name: Determine package name
        id: pkg
        run: |
          if [ -n "${{ inputs.package_name }}" ]; then
            echo "name=${{ inputs.package_name }}" >> "$GITHUB_OUTPUT"
          else
            # Extract from Cargo.toml
            NAME=$(grep -m1 '^name' Cargo.toml | sed 's/name *= *"\(.*\)"/\1/')
            echo "name=$NAME" >> "$GITHUB_OUTPUT"
          fi

      - name: Check if should publish to crates.io
        id: check-token
        run: |
          if [ -n "${{ secrets.CARGO_REGISTRY_TOKEN }}" ]; then
            echo "should_publish=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Build target matrix
        id: set-matrix
        run: |
          TARGETS='${{ inputs.targets }}'
          MATRIX="["
          FIRST=true

          for target in $(echo "$TARGETS" | jq -r '.[]'); do
            case "$target" in
              windows)
                [ "$FIRST" = true ] && FIRST=false || MATRIX+=","
                MATRIX+='{"target":"x86_64-pc-windows-msvc","os":"windows-latest","ext":".exe"}'
                ;;
              linux)
                [ "$FIRST" = true ] && FIRST=false || MATRIX+=","
                MATRIX+='{"target":"x86_64-unknown-linux-gnu","os":"ubuntu-latest","ext":""}'
                ;;
              macos)
                [ "$FIRST" = true ] && FIRST=false || MATRIX+=","
                MATRIX+='{"target":"aarch64-apple-darwin","os":"macos-latest","ext":""}'
                ;;
            esac
          done

          MATRIX+="]"
          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"

  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Format check
        run: cargo fmt --check

      # - name: Clippy
      #   run: cargo clippy -- -D warnings

  test:
    runs-on: ubuntu-latest
    needs: check
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Run tests
        run: cargo test --all-features

  build:
    needs: [prepare, test]
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      - name: Build release
        run: cargo build --release --target ${{ matrix.target }}

      - name: Rename binary
        shell: bash
        run: |
          PKG="${{ needs.prepare.outputs.package_name }}"
          SRC="target/${{ matrix.target }}/release/${PKG}${{ matrix.ext }}"
          DST="${PKG}-${{ matrix.target }}${{ matrix.ext }}"
          cp "$SRC" "$DST"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ needs.prepare.outputs.package_name }}-${{ matrix.target }}
          path: ${{ needs.prepare.outputs.package_name }}-${{ matrix.target }}${{ matrix.ext }}

  publish:
    needs: [prepare, test]
    if: inputs.publish_to_crate || needs.prepare.outputs.should_publish == true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Publish to crates.io
        run: cargo publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  release:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          name: v${{ needs.prepare.outputs.version }}
          generate_release_notes: true
          files: artifacts/*

  pages:
    needs: [prepare, release]
    if: inputs.deploy_pages
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Build download page
        env:
          PACKAGE_NAME: ${{ needs.prepare.outputs.package_name }}
          VERSION: ${{ needs.prepare.outputs.version }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          mkdir -p public

          # Copy binaries to public folder
          cp artifacts/* public/ 2>/dev/null || true

          # Generate download page
          cat > public/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${PACKAGE_NAME} - Downloads</title>
            <style>
              * { box-sizing: border-box; margin: 0; padding: 0; }
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; color: #e4e4e4; }
              .container { max-width: 800px; margin: 0 auto; padding: 2rem; }
              header { text-align: center; padding: 3rem 0; }
              h1 { font-size: 2.5rem; margin-bottom: 0.5rem; background: linear-gradient(90deg, #00d9ff, #00ff88); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
              .version { color: #888; font-size: 1.1rem; }
              .downloads { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 2rem; margin-top: 2rem; }
              .downloads h2 { margin-bottom: 1.5rem; color: #00d9ff; }
              .download-list { list-style: none; }
              .download-item { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 1rem; transition: all 0.2s; }
              .download-item:hover { background: rgba(255,255,255,0.08); border-color: #00d9ff; }
              .download-link { display: flex; align-items: center; padding: 1rem 1.5rem; color: #e4e4e4; text-decoration: none; }
              .platform { font-weight: 600; flex: 1; }
              .filename { color: #888; font-size: 0.9rem; }
              .icon { font-size: 1.5rem; margin-right: 1rem; }
              footer { text-align: center; padding: 2rem 0; color: #666; font-size: 0.9rem; }
              footer a { color: #00d9ff; text-decoration: none; }
            </style>
          </head>
          <body>
            <div class="container">
              <header>
                <h1>PACKAGE_NAME_PLACEHOLDER</h1>
                <p class="version">Version VERSION_PLACEHOLDER</p>
              </header>
              <section class="downloads">
                <h2>üì¶ Download</h2>
                <ul class="download-list" id="downloads"></ul>
              </section>
              <footer>
                <p>View on <a href="https://github.com/REPO_PLACEHOLDER/releases">GitHub Releases</a></p>
              </footer>
            </div>
            <script>
              const files = FILELIST_PLACEHOLDER;
              const platforms = {
                'x86_64-pc-windows-msvc': { name: 'Windows (x64)', icon: 'ü™ü' },
                'x86_64-unknown-linux-gnu': { name: 'Linux (x64)', icon: 'üêß' },
                'aarch64-unknown-linux-gnu': { name: 'Linux (ARM64)', icon: 'üêß' },
                'aarch64-apple-darwin': { name: 'macOS (Apple Silicon)', icon: 'üçé' },
                'x86_64-apple-darwin': { name: 'macOS (Intel)', icon: 'üçé' }
              };
              const list = document.getElementById('downloads');
              files.forEach(file => {
                const platform = Object.keys(platforms).find(p => file.includes(p)) || 'unknown';
                const info = platforms[platform] || { name: 'Other', icon: 'üìÅ' };
                const li = document.createElement('li');
                li.className = 'download-item';
                li.innerHTML = `<a href="${file}" class="download-link"><span class="icon">${info.icon}</span><span class="platform">${info.name}</span><span class="filename">${file}</span></a>`;
                list.appendChild(li);
              });
            </script>
          </body>
          </html>
          HTMLEOF

          # Replace placeholders
          FILELIST=$(ls public/ | grep -v index.html | jq -R -s -c 'split("\n") | map(select(length > 0))')
          sed -i "s|PACKAGE_NAME_PLACEHOLDER|${PACKAGE_NAME}|g" public/index.html
          sed -i "s|VERSION_PLACEHOLDER|${VERSION}|g" public/index.html
          sed -i "s|REPO_PLACEHOLDER|${GITHUB_REPOSITORY}|g" public/index.html
          sed -i "s|FILELIST_PLACEHOLDER|${FILELIST}|g" public/index.html

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
